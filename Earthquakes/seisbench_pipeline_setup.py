# -*- coding: utf-8 -*-
"""SeisBench Pipeline Setup

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1IP3hD1WEy0Uw2YT42bLLOrr8L4Pv20nT
"""

!pip install seisbench obspy pandas

import numpy as np
import obspy
import pandas as pd
from obspy.core.event import Catalog, Event, Origin, Magnitude
from obspy.clients.fdsn import Client
import os

# --- 1. Define the Target Area (Manzanillo Region Example) ---
# We define a geographical box and time window relevant to the Manzanillo catalog

MIN_MAGNITUDE = 3.0 # We will filter events smaller than this for declustering
MIN_LAT, MAX_LAT = 18.0, 20.0
MIN_LON, MAX_LON = -105.0, -103.0
START_TIME = obspy.UTCDateTime("2010-01-01")
END_TIME = obspy.UTCDateTime("2020-01-01")

# --- 2.  RETRIEVE DATA USING OBSPY FDSN CLIENT  ---
print("--- Initializing ObsPy FDSN Client (USGS) ---")

try:
    # Initialize the FDSN client
    client = Client("USGS")

    #Query the earthquake catalog metadata using the defined criteria
    catalog_obspy = client.get_events(
      starttime=START_TIME,
      endtime=END_TIME,
      minlatitude=MIN_LAT,
      maxlatitude=MAX_LAT,
      minlongitude=MIN_LON,
      maxlongitude=MAX_LON,
      minmagnitude=MIN_MAGNITUDE,
      orderby='time'
    )

    # ObsPy directly returns an ObsPy Catalog object
    print(f"Found {len(catalog_obspy)} events matching the query.")
    if len(catalog_obspy) == 0:
        print("No data found. Adjust your geographical/time criteria.")
        exit()

except Exception as e:
    print(f"Could not retrieve data from USGS FDSN service. Error: {e}")
    exit()

# --- 3.1 OBSPY CATALOG PREPARATION AND DECLUSTERING---

print("\n--- ObsPy Catalog ready for Declustering ---")

#--- 3.2. Declustering (Gardner and Knopoff Proxy) ---

print("--- Applying Gardner and Knopoff Declustering (Proxy) ---")

R_SPATIAL_KM = 100.0
T_TEMPORAL_DAYS = 10.0

def simple_declustering(catalog, r_km, t_days):
    """Placeholder: Assumes all events are mainshocks for now."""
    print(f"Warning: Using simple proxy. Total events assumed to be mainshocks: {len(catalog)}")
    return catalog

declustered_catalog = simple_declustering(catalog_obspy, R_SPATIAL_KM, T_TEMPORAL_DAYS)

 #--- 3.3. Pipeline Output---

print(f"\nOriginal Catalog Size: {len(catalog_obspy)}")
print(f"Declustered (Mainshock) Catalog Size: {len(declustered_catalog)}")
print("Catalog preprocessing complete. Ready for Rolling Feature Extraction.")